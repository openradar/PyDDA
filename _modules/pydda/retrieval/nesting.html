
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pydda.retrieval.nesting &#8212; PyDDA 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">PyDDA 0.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pydda.retrieval.nesting</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyart</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">from</span> <span class="nn">distributed</span> <span class="k">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">wait</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">.wind_retrieve</span> <span class="k">import</span> <span class="n">get_dd_wind_field</span>


<span class="c1"># Reduces the resolution of a PyART grid</span>
<span class="k">def</span> <span class="nf">_reduce_pyart_grid_res</span><span class="p">(</span><span class="n">Grid</span><span class="p">,</span> <span class="n">skip_factor</span><span class="p">):</span>
    <span class="n">Grid2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Grid</span><span class="p">)</span>
    <span class="n">field_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">field_dict</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">field_dict</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
            <span class="p">:,</span> <span class="p">::</span><span class="n">skip_factor</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_factor</span><span class="p">]</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">x</span>
    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][::</span><span class="n">skip_factor</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">y</span>
    <span class="n">y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][::</span><span class="n">skip_factor</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">z</span>
    <span class="n">z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">origin_latitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">origin_latitude</span>
    <span class="n">origin_longitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">origin_longitude</span>
    <span class="n">origin_altitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">origin_altitude</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">projection</span>
    <span class="n">radar_latitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_latitude</span>
    <span class="n">radar_longitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_longitude</span>
    <span class="n">radar_altitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_altitude</span>
    <span class="n">radar_time</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_time</span>
    <span class="n">radar_name</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_name</span>
    <span class="n">gtime</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">time</span>
    <span class="n">new_grid</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span>
        <span class="n">gtime</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">origin_latitude</span><span class="p">,</span> <span class="n">origin_longitude</span><span class="p">,</span>
        <span class="n">origin_altitude</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">radar_latitude</span><span class="p">,</span> <span class="n">radar_longitude</span><span class="p">,</span>
        <span class="n">radar_altitude</span><span class="p">,</span> <span class="n">radar_time</span><span class="p">,</span> <span class="n">radar_name</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">Grid2</span>
    <span class="k">return</span> <span class="n">new_grid</span>


<span class="c1"># Splits a Py-ART Grid</span>
<span class="k">def</span> <span class="nf">_split_pyart_grid</span><span class="p">(</span><span class="n">Grid</span><span class="p">,</span> <span class="n">split_factor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">grid_splits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">split_field</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Grid2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">Grid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
            <span class="n">no_mask</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">no_mask</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">split_field</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span>
            <span class="n">no_mask</span><span class="p">,</span> <span class="n">split_factor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
            <span class="n">split_field</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">split_field</span><span class="p">[</span><span class="n">field_name</span><span class="p">]]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">x</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">y</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">z</span>
    <span class="n">x_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">split_factor</span><span class="p">)</span>
    <span class="n">y_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">split_factor</span><span class="p">)</span>
    <span class="n">z_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">split_factor</span><span class="p">)</span>
    <span class="n">gtime</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">time</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">origin_latitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">origin_latitude</span>
    <span class="n">origin_longitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">origin_longitude</span>
    <span class="n">origin_altitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">origin_altitude</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">projection</span>
    <span class="n">radar_latitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_latitude</span>
    <span class="n">radar_longitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_longitude</span>
    <span class="n">radar_altitude</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_altitude</span>
    <span class="n">radar_time</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_time</span>
    <span class="n">radar_name</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">radar_name</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">split_factor</span><span class="p">):</span>
        <span class="n">grid_dic</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">grid_dic</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Grid2</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">grid_dic</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_field</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x_dic</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_dic</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">z_dic</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">y_dic</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_split</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">x_dic</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_split</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">z_dic</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_split</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">new_grid</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Grid</span><span class="p">(</span>
            <span class="n">gtime</span><span class="p">,</span> <span class="n">grid_dic</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">origin_latitude</span><span class="p">,</span> <span class="n">origin_longitude</span><span class="p">,</span>
            <span class="n">origin_altitude</span><span class="p">,</span> <span class="n">x_dic</span><span class="p">,</span> <span class="n">y_dic</span><span class="p">,</span> <span class="n">z_dic</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">radar_latitude</span><span class="p">,</span>
            <span class="n">radar_longitude</span><span class="p">,</span> <span class="n">radar_altitude</span><span class="p">,</span> <span class="n">radar_time</span><span class="p">,</span> <span class="n">radar_name</span><span class="p">)</span>
        <span class="n">grid_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_grid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid_splits</span>


<span class="c1"># Concatenates Py-ART Grids</span>
<span class="k">def</span> <span class="nf">_concatenate_pyart_grids</span><span class="p">(</span><span class="n">grid_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">new_grid</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">grid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">new_grid</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">])</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">nx</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">])</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">])</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ny</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">])</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">])</span>
        <span class="n">new_grid</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">nz</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_grid</span>


<span class="c1"># Procedure: 1. Do first pass of retrieval on reduced resolution grid</span>
<span class="c1"># 2. Then, we use the reduced resolution retrieval as an input to the</span>
<span class="c1"># high resolution retrieval in each region</span>
<span class="c1"># Finally, we check for continuity at the boundaries</span>
<div class="viewcode-block" id="get_dd_wind_field_nested"><a class="viewcode-back" href="../../../dev_reference/generated/pydda.retrieval.get_dd_wind_field_nested.html#pydda.retrieval.get_dd_wind_field_nested">[docs]</a><span class="k">def</span> <span class="nf">get_dd_wind_field_nested</span><span class="p">(</span><span class="n">grid_list</span><span class="p">,</span> <span class="n">u_init</span><span class="p">,</span> <span class="n">v_init</span><span class="p">,</span> <span class="n">w_init</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
                             <span class="n">reduction_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_splits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs a wind retrieval using a nested domain.</span>
<span class="sd">    This is useful for grids that are larger than about 500 by 500</span>
<span class="sd">    by 40 points, since the use of larger grids on a single machine</span>
<span class="sd">    will exceed memory limitations.</span>

<span class="sd">    This procedure relies on a dask distributed cluster to be set up.</span>
<span class="sd">    The retrieval is first performed at a resolution that is coarser</span>
<span class="sd">    than the analysis grid by reduction_factor. This provides the</span>
<span class="sd">    initial state for the nested loop.</span>

<span class="sd">    The domain is split into num_splits**2 sub-domains for the nested</span>
<span class="sd">    retrieval step, and each nested retrieval is mapped onto a distributed</span>
<span class="sd">    worker for parallel processing. If NumPy and SciPy are already set up to</span>
<span class="sd">    use parallel numerical analysis libraries, it is recommended that a single</span>
<span class="sd">    machine be dedicated to each nest rather than a single core</span>
<span class="sd">    for best performance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    grid_list: list</span>
<span class="sd">       A list of Py-ART grids for each radar to use in the retrieval.</span>
<span class="sd">    u_init: 3D NumPy array</span>
<span class="sd">       The initial guess of the zonal wind field. This has to be in the same</span>
<span class="sd">       shape as the analysis grid.</span>
<span class="sd">    v_init: 3D NumPy array</span>
<span class="sd">       The initial guess of the meridional wind field. This has to be in the</span>
<span class="sd">       same shape as the analysis grid.</span>
<span class="sd">    w_init: 3D NumPy array</span>
<span class="sd">       The initial guess of the vertical wind field. This has to be in the same</span>
<span class="sd">       shape as the analysis grid.</span>
<span class="sd">    client: dask distributed Client</span>
<span class="sd">       The distributed Client that is linked to a distributed cluster. The</span>
<span class="sd">       :cluster must be running before get_dd_wind_field_nested is called.</span>
<span class="sd">       The retrieval on each nest will be mapped onto each worker. Since</span>
<span class="sd">       the optimization loop already takes advantage of parallelism, it&#39;s</span>
<span class="sd">       best to allow at least 16 cores per one worker.</span>
<span class="sd">    reduction_factor: int</span>
<span class="sd">       How much to reduce the factor of the analysis grid by when doing the</span>
<span class="sd">       initial retrieval on the entire grid.</span>
<span class="sd">    num_splits: int</span>
<span class="sd">       The number of splits to make through each axis when doing the nesting.</span>

<span class="sd">    **kwargs: dict</span>
<span class="sd">        This function will take the same keyword arguments as</span>
<span class="sd">        get_dd_wind_field, as these arguments are passed into each call of</span>
<span class="sd">        get_dd_wind_field. See get_dd_wind_field for more information on the</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, we do retrieval on whole grid with fraction of resolution</span>
    <span class="n">grid_lo_res_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_reduce_pyart_grid_res</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">G</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">]</span>

    <span class="n">first_pass</span> <span class="o">=</span> <span class="n">get_dd_wind_field</span><span class="p">(</span>
        <span class="n">grid_lo_res_list</span><span class="p">,</span> <span class="n">u_init</span><span class="p">[::,</span> <span class="p">::</span><span class="n">reduction_factor</span><span class="p">,</span> <span class="p">::</span><span class="n">reduction_factor</span><span class="p">],</span>
        <span class="n">v_init</span><span class="p">[::,</span> <span class="p">::</span><span class="n">reduction_factor</span><span class="p">,</span> <span class="p">::</span><span class="n">reduction_factor</span><span class="p">],</span>
        <span class="n">w_init</span><span class="p">[::,</span> <span class="p">::</span><span class="n">reduction_factor</span><span class="p">,</span> <span class="p">::</span><span class="n">reduction_factor</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Take the first pass field and regrid to analysis field</span>
    <span class="n">reduced_x</span> <span class="o">=</span> <span class="n">first_pass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">reduced_y</span> <span class="o">=</span> <span class="n">first_pass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">reduced_z</span> <span class="o">=</span> <span class="n">first_pass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">grid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_x</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">grid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_y</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">grid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_z</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">u_init_new</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">((</span><span class="n">reduced_z</span><span class="p">,</span> <span class="n">reduced_y</span><span class="p">,</span> <span class="n">reduced_x</span><span class="p">),</span>
                          <span class="n">first_pass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                          <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">v_init_new</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">((</span><span class="n">reduced_z</span><span class="p">,</span> <span class="n">reduced_y</span><span class="p">,</span> <span class="n">reduced_x</span><span class="p">),</span>
                          <span class="n">first_pass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                          <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">w_init_new</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">((</span><span class="n">reduced_z</span><span class="p">,</span> <span class="n">reduced_y</span><span class="p">,</span> <span class="n">reduced_x</span><span class="p">),</span>
                          <span class="n">first_pass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                          <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">u_init_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">u_init_new</span><span class="p">,</span> <span class="n">u_init</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">v_init_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">v_init_new</span><span class="p">,</span> <span class="n">v_init</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">w_init_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">w_init_new</span><span class="p">,</span> <span class="n">w_init</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Finally, split the analysis into num_splits**2 pieces and save</span>
    <span class="c1"># as temporary files</span>
    <span class="n">tempfile_name_base</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">.%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">tiny_grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">G</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">:</span>
        <span class="n">cur_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">split_grids_x</span> <span class="o">=</span> <span class="n">_split_pyart_grid</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sgrid</span> <span class="ow">in</span> <span class="n">split_grids_x</span><span class="p">:</span>
            <span class="n">g_list</span> <span class="o">=</span> <span class="n">_split_pyart_grid</span><span class="p">(</span><span class="n">sgrid</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">)</span>
            <span class="n">grid_fns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_list</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempfile_name_base</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                      <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
                <span class="n">pyart</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_grid</span><span class="p">((</span><span class="n">tempfile_name_base</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span>
                                     <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">),</span> <span class="n">g</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">grid_fns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">cur_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_fns</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">del</span> <span class="n">split_grids_x</span><span class="p">,</span> <span class="n">g_list</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">tiny_grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_list</span><span class="p">)</span>

    <span class="c1"># Temporarily save the tiny grids and free up memory...we want to</span>
    <span class="c1"># load these when we are running it on the cluster</span>

    <span class="n">u_init_split_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">u_init_new</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">u_init_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">ux</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ux</span> <span class="ow">in</span> <span class="n">u_init_split_x</span><span class="p">]</span>
    <span class="n">w_init_split_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">w_init_new</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">w_init_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">wx</span> <span class="ow">in</span> <span class="n">w_init_split_x</span><span class="p">]</span>
    <span class="n">v_init_split_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">v_init_new</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">v_init_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="n">v_init_split_x</span><span class="p">]</span>

    <span class="c1"># Clear out unneeded variables (do not need lo-res grids in memory anymore)</span>
    <span class="k">del</span> <span class="n">u_init_split_x</span><span class="p">,</span> <span class="n">w_init_split_x</span><span class="p">,</span> <span class="n">v_init_split_x</span>
    <span class="k">del</span> <span class="n">first_pass</span><span class="p">,</span> <span class="n">reduced_x</span><span class="p">,</span> <span class="n">reduced_y</span><span class="p">,</span> <span class="n">reduced_z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">grid_lo_res_list</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Serial just for testing, need to use dask in future</span>
    <span class="n">tiny_retrieval</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">do_tiny_retrieval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">tgrids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyart</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_grid</span><span class="p">(</span><span class="n">tiny_grids</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_list</span><span class="p">))]</span>
        <span class="n">new_grids</span> <span class="o">=</span> <span class="n">get_dd_wind_field</span><span class="p">(</span>
            <span class="n">tgrids</span><span class="p">,</span> <span class="n">u_init_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">v_init_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
            <span class="n">w_init_split</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">tgrids</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_grids</span>

    <span class="n">futures_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_splits</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_splits</span><span class="p">):</span>
            <span class="n">futures_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">do_tiny_retrieval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for nested grid to be retrieved...&quot;</span><span class="p">)</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">futures_array</span><span class="p">)</span>
    <span class="n">tiny_retrieval2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures_array</span><span class="p">)</span>
    <span class="n">tiny_retrieval</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_splits</span><span class="p">):</span>
        <span class="n">new_grid_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_list</span><span class="p">)):</span>
            <span class="n">new_grid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_concatenate_pyart_grids</span><span class="p">(</span>
                <span class="p">[</span><span class="n">tiny_retrieval2</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">num_splits</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_splits</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">tiny_retrieval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_grid_list</span><span class="p">)</span>

    <span class="n">new_grid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_list</span><span class="p">)):</span>
        <span class="n">new_grid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_concatenate_pyart_grids</span><span class="p">(</span>
            <span class="p">[</span><span class="n">tiny_retrieval</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_splits</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">tempfile_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">tempfile_name_base</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">tempfile_list</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_grid_list</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">PyDDA 0.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, PyDDA Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>